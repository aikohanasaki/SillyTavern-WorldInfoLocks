# 🌎 世界資訊鎖（SillyTavern 擴充套件）

World Info Locks 是一套為 SillyTavern「世界資訊（World Info）」功能提供的完整預設管理系統。它最初分支自 [World Info Presets](https://github.com/LenAnderson/SillyTavern-WorldInfoPresets/)，並已發展為能在不同情境中管理傳說書（lorebook）組態的強大工具。

![SillyTavern 世界資訊鎖介面](https://github.com/aikohanasaki/imagehost/blob/main/STWIL.png)

## 🌟 主要功能

### 📚 世界資訊預設
- 儲存與載入預設：建立具名預設，包含世界資訊書與啟用設定
- 智慧書籍管理：自動處理多本世界資訊書的載入/卸載
- 啟用設定：可選擇捕捉並還原世界資訊的啟用設定（深度、預算、遞迴、匹配規則等）
- 細緻的設定控制：可為每個預設精確挑選要包含的啟用設定
- 角色 Lore 保護：切換預設時智慧保留角色專屬的 lore 資料

### 🔒 進階鎖定系統
- 角色鎖：將特定預設鎖定至單一角色
- 聊天鎖：將預設鎖定至特定對話
- 鎖定優先順序：可設定聊天鎖或角色鎖的優先權
- 群組聊天支援：在群組對話中妥善處理（停用角色鎖、允許聊天鎖）

### 🌍 全域預設
- 全域預設：為未鎖定的角色/聊天設定後援預設
- 自動套用：依據情境無縫套用合適的預設
- 智慧通知：預設變更時可選擇顯示快顯通知

### 📤 匯入/匯出系統
- 完整預設匯出：匯出預設與所有關聯的世界資訊書
- 角色鎖匯出：包含角色鎖定組態
- 全域預設匯出：標記並還原全域預設設定
- 彈性匯入選項：可選擇是否包含書籍、是否覆蓋現有預設等

### 🔧 智慧管理
- 書籍重新命名偵測：世界資訊書改名時，自動更新引用該書的所有預設
- 衝突解決：匯入預設時對名稱衝突進行智慧處理
- 即時更新：切換情境時 UI 即時反映
- 快取系統：基於情境的智慧快取以優化效能

## 📖 使用指南

### 建立你的第一個預設

1. 設定你的世界資訊：選擇世界資訊書並依需求設定啟用選項
2. 建立預設：點擊 ➕ 按鈕並替預設命名
3. 選擇要包含的設定：挑選要隨預設儲存的世界資訊啟用設定  
![可選擇的啟用設定（可忽略）](https://github.com/aikohanasaki/imagehost/blob/main/STWIL%20WI%20settings.png)
   - 啟用設定：控制何時以及如何啟用條目（深度、最小啟用數、遞迴）
   - 預算與效能：記憶體使用與 token 限制
   - 文字匹配：關鍵字匹配行為（區分大小寫、全詞匹配）
   - 策略與計分：啟用優先順序與計分規則
   - 或選擇不保存任何設定（僅保存書籍選擇）
4. 之後啟用：使用下拉選單隨時切換預設

### 設定鎖定

![鎖定至角色或聊天](https://github.com/aikohanasaki/imagehost/blob/main/STWIL%20lock.png)

1. 選擇一個預設：挑選你想鎖定的預設
2. 開啟鎖定設定：點擊 🔒 按鈕
3. 選擇鎖定類型：
   - ✅ 鎖定至角色：與該角色聊天時自動套用此預設
   - ✅ 鎖定至聊天：在該特定對話中自動套用此預設
4. 確認：點擊 OK 儲存鎖定設定

### 設定全域選項

![所有設定](https://github.com/aikohanasaki/imagehost/blob/main/STWIL%20menu.png)

1. 開啟設定：點擊 ⚙️ 按鈕
2. 設定全域預設：選擇在無鎖定時要套用的預設
3. 設定鎖定行為：
   - 啟用/停用角色鎖
   - 啟用/停用聊天鎖
   - 選擇鎖定優先順序（聊天優先或角色優先）
   - 切換鎖定通知

### 匯入/匯出流程

~[匯出](https://github.com/aikohanasaki/imagehost/blob/main/STWIL%20export.png)

**匯出：**
1. 選擇要匯出的預設
2. 點擊 📤 Export 按鈕
3. 選擇選項：
   - 包含書籍內容
   - 使用目前選取取代預設定義
4. 儲存產生的 JSON 檔案

**匯入：**
1. 點擊 📥 Import 按鈕
2. 選擇你的預設 JSON 檔案
3. 處理任何命名衝突
4. 選擇是否匯入包含的書籍與角色鎖

## 🎯 進階功能

![世界資訊啟用設定](https://github.com/aikohanasaki/imagehost/blob/main/STWIL%20WI.png)

### 世界資訊啟用設定
每個預設可選擇包含控制條目啟用行為的世界資訊啟用設定：

- 啟用設定：掃描深度、最小啟用數、遞迴行為
- 預算與效能：token 預算、預算上限、溢出警示
- 文字匹配：區分大小寫、全詞匹配、包含角色名稱
- 策略與計分：角色 vs 全域優先權、群組計分行為

在建立或更新預設時，你可以精確選擇要納入的設定。不含設定的預設僅管理書籍選擇。啟用包含設定的預設時，這些設定會自動套用。

### 書籍重新命名偵測
當你重新命名某本世界資訊書時，擴充套件會偵測此變更，並提供更新所有引用舊名稱的預設為新名稱。

### 斜線指令支援
使用 `/wipreset` 快速切換預設：
```
/wipreset MyPresetName
/wipreset  //（留白以停用目前預設）
```

### 情境感知行為
- 角色變更：切換角色時自動套用角色鎖定的預設
- 聊天變更：切換對話時套用聊天鎖定的預設
- 群組聊天：做出適當調整（停用角色鎖、以群組名稱進行聊天鎖）

## ⚙️ 設定選項

| 設定 | 說明 | 預設值 |
|------|------|--------|
| 全域預設 | 當未選定特定預設且無鎖定時套用的預設 | 無 |
| 啟用角色鎖 | 允許將預設鎖定至特定角色 | ✅ 已啟用 |
| 啟用聊天鎖 | 允許將預設鎖定至特定聊天 | ✅ 已啟用 |
| 聊天優先於角色鎖 | 當兩者同時存在時，聊天鎖優先於角色鎖 | ❌ 未啟用 |
| 顯示鎖定通知 | 套用鎖定預設時顯示快顯通知 | ✅ 已啟用 |

## 🔄 自 World Info Presets 遷移

如果你正從原始的 World Info Presets 擴充套件升級：

1. 你現有的預設會自動保留
2. 原擴充套件的所有功能皆被保留
3. 新的鎖定與全域預設功能可立即使用
4. 不需要任何手動遷移步驟

## 🐛 疑難排解

預設未正確套用？
- 檢查所有引用的世界資訊書是否仍然存在
- 在 🔒 選單確認鎖定設定
- 在 ⚙️ 選單檢查全域預設設定

角色鎖無效？
- 確認設定中已啟用角色鎖
- 確認目前不在群組聊天中（群組聊天停用角色鎖）
- 檢查角色名稱是否完全一致

沒有通知？
- 在設定選單中啟用「顯示鎖定通知」

## 🤝 貢獻

此擴充套件被視為功能齊全，但依然歡迎貢獻！你可以：
- 透過 GitHub Issues 回報錯誤（持續維護）
- 針對 SillyTavern 更新提交相容性修正
- 改善文件與示例
- 分享使用技巧與工作流程

> 注意：雖然此擴充套件功能已趨完整，但仍非常歡迎錯誤回報與相容性更新，以確保能隨 SillyTavern 的更新穩定運作。

## 🙏 致謝

- 原始擴充套件 [World Info Presets](https://github.com/LenAnderson/SillyTavern-WorldInfoPresets/) 作者：LenAnderson
