# 🌎 世界信息锁（SillyTavern 扩展）

World Info Locks 是一个为 SillyTavern 的世界信息（World Info）功能提供的完整预设管理系统。它最初基于 [World Info Presets](https://github.com/LenAnderson/SillyTavern-WorldInfoPresets/) 分叉而来，现已发展为一个能够在不同上下文中管理传说书（lorebook）配置的强大工具。

![SillyTavern 世界信息锁界面](https://github.com/aikohanasaki/imagehost/blob/main/STWIL.png)

## 🌟 主要特性

### 📚 世界信息预设
- 保存与加载预设：创建具名预设，包含世界信息书与激活设置
- 智能书本管理：自动处理多个世界信息书的加载/卸载
- 激活设置：可选地捕获并恢复世界信息的激活设置（深度、预算、递归、匹配规则等）
- 细粒度设置控制：为每个预设精确选择要包含的激活设置
- 角色 Lore 保护：在切换预设时智能保留角色专属的 lore 数据

### 🔒 高级锁定系统
- 角色锁：将特定预设锁定到单个角色
- 会话锁：将预设锁定到特定对话
- 锁定优先级：可配置会话锁与角色锁的优先关系
- 群聊支持：在群聊中进行恰当处理（禁用角色锁，允许会话锁）

### 🌍 全局默认
- 全局默认预设：为未锁定的角色/会话设置兜底预设
- 自动应用：基于上下文无缝应用合适的预设
- 智能通知：预设变更时可选显示吐司通知

### 📤 导入/导出系统
- 完整预设导出：导出预设及其关联的世界信息书
- 角色锁导出：包含角色锁定配置
- 全局默认导出：标记并恢复全局默认设置
- 灵活导入选项：可选择包含书本、是否覆盖现有预设等

### 🔧 智能管理
- 书本重命名检测：世界信息书改名时自动更新引用它的预设
- 冲突处理：导入时对预设重名进行智能处理
- 实时更新：切换上下文时 UI 实时更新
- 缓存系统：基于上下文的智能缓存以优化性能

## 📖 使用指南

### 创建你的第一个预设

1. 设置你的世界信息：选择世界信息书并按需配置激活设置
2. 创建预设：点击 ➕ 按钮并为预设命名
3. 选择要包含的设置：挑选要随预设保存的世界信息激活设置  
![可选择的激活设置（可忽略）](https://github.com/aikohanasaki/imagehost/blob/main/STWIL%20WI%20settings.png)
   - 激活设置：控制何时以及如何激活条目（深度、最小激活数、递归）
   - 预算与性能：内存占用与令牌限制
   - 文本匹配：关键字匹配行为（区分大小写、全词匹配）
   - 策略与计分：激活优先级与计分规则
   - 或者不保存任何设置（仅保存书本选择）
4. 之后启用：使用下拉菜单随时切换预设

### 设置锁

![锁定到角色或会话](https://github.com/aikohanasaki/imagehost/blob/main/STWIL%20lock.png)

1. 选择一个预设：挑选你要锁定的预设
2. 打开锁定设置：点击 🔒 按钮
3. 选择锁类型：
   - ✅ 锁定到角色：与该角色聊天时自动应用此预设
   - ✅ 锁定到会话：在该特定会话中自动应用此预设
4. 确认：点击 OK 保存锁定设置

### 配置全局设置

![所有设置](https://github.com/aikohanasaki/imagehost/blob/main/STWIL%20menu.png)

1. 打开设置：点击 ⚙️ 按钮
2. 设置全局默认：选择在无锁定时应用的预设
3. 配置锁定行为：
   - 启用/禁用角色锁
   - 启用/禁用会话锁
   - 选择锁定优先级（会话优先或角色优先）
   - 切换锁定通知

### 导入/导出流程

~[导出](https://github.com/aikohanasaki/imagehost/blob/main/STWIL%20export.png)

**导出：**
1. 选择要导出的预设
2. 点击 📤 Export 按钮
3. 选择选项：
   - 包含书本内容
   - 使用当前选择替代预设定义
4. 保存生成的 JSON 文件

**导入：**
1. 点击 📥 Import 按钮
2. 选择你的预设 JSON 文件
3. 处理任何命名冲突
4. 选择是否导入包含的书本与角色锁

## 🎯 高级功能

![世界信息激活设置](https://github.com/aikohanasaki/imagehost/blob/main/STWIL%20WI.png)

### 世界信息激活设置
每个预设都可选地包含控制条目激活行为的世界信息激活设置：

- 激活设置：扫描深度、最小激活数、递归行为
- 预算与性能：令牌预算、预算上限、溢出提醒
- 文本匹配：区分大小写、全词匹配、包含角色名
- 策略与计分：角色 vs 全局优先级、群组计分行为

在创建或更新预设时，你可以精确选择要包含的设置。不包含设置的预设仅管理书本选择。启用包含设置的预设时，这些设置会自动应用。

### 书本重命名检测
当你重命名某个世界信息书时，扩展会检测此变更，并提供更新所有引用旧名称的预设为新名称。

### 斜杠命令支持
使用 `/wipreset` 快速切换预设：
```
/wipreset MyPresetName
/wipreset  //（留空以停用当前预设）
```

### 上下文感知行为
- 角色变化：切换角色时自动应用角色锁定的预设
- 会话变化：切换会话时应用会话锁定的预设
- 群聊：做出相应适配（禁用角色锁，使用群组名称进行会话锁）

## ⚙️ 配置选项

| 设置 | 描述 | 默认值 |
|------|------|--------|
| 全局默认预设 | 当未选择特定预设且无锁定时应用的预设 | 无 |
| 启用角色锁 | 允许将预设锁定到特定角色 | ✅ 启用 |
| 启用会话锁 | 允许将预设锁定到特定会话 | ✅ 启用 |
| 会话优先于角色锁 | 当两者同时存在时，会话锁优先于角色锁 | ❌ 禁用 |
| 显示锁定通知 | 应用锁定预设时显示吐司通知 | ✅ 启用 |

## 🔄 从 World Info Presets 迁移

如果你从原始的 World Info Presets 扩展升级：

1. 你现有的预设会被自动保留
2. 原扩展的全部功能均被保留
3. 新的锁定与全局默认功能可直接使用
4. 无需任何手动迁移步骤

## 🐛 故障排查

预设未正确应用？
- 检查所有引用的世界信息书是否仍然存在
- 在 🔒 菜单中核对锁定设置
- 在 ⚙️ 菜单中检查全局默认设置

角色锁不起作用？
- 确认设置中已启用角色锁
- 确认当前不在群聊中（群聊禁用角色锁）
- 检查角色名称是否完全一致

没有通知？
- 在设置菜单中启用“显示锁定通知”

## 🤝 贡献

该扩展被视为功能完备，但仍欢迎贡献！你可以：
- 通过 GitHub Issue 报告 Bug（积极维护）
- 针对 SillyTavern 更新提交兼容性修复
- 改进文档与示例
- 分享使用技巧与工作流

> 注意：虽然该扩展功能已完善，但欢迎提交 Bug 报告与兼容性更新，以确保在 SillyTavern 的更新中保持稳定。

## 🙏 致谢

- 原始扩展 [World Info Presets](https://github.com/LenAnderson/SillyTavern-WorldInfoPresets/) 作者：LenAnderson
